Fix handshake and integrate with event loop
